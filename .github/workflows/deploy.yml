# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
# This workflow will build a Java project with Gradle and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle

name: Deploy Frontend + Backend (Docker)

on:
  push:
    branches: ["main"]
    paths:
      - "novels/frontend/**"
      - "novels/backend/**"
      - ".github/workflows/deploy.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- Frontend (Vite) ----------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: Install frontend deps
        working-directory: frontend/novels
        run: npm ci

      - name: Build frontend
        working-directory: frontend/novels
        run: npm run build

      # ---------- Backend (Spring Boot) ----------
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: "gradle"

      # gradlew 실행 권한 부여
      - name: Make gradlew executable
        working-directory: backend/novels
        run: chmod +x gradlew

      - name: Build backend (skip tests)
        working-directory: backend/novels
        run: ./gradlew clean build -x test

      # ---------- Prepare artifacts ----------
      - name: Prepare artifacts
        run: |
          mkdir -p artifacts/frontend artifacts/backend

          # frontend dist
          cp -r frontend/novels/dist/* artifacts/frontend/

          # backend jar -> app.jar (plain.jar 제외)
          JAR_PATH=$(ls backend/novels/build/libs/*.jar | grep -v -- '-plain\.jar' | head -n 1)
          if [ -z "$JAR_PATH" ]; then
            echo "No runnable jar found in novels/backend/build/libs"
            ls -al backend/novels/build/libs || true
            exit 1
          fi
          cp "$JAR_PATH" artifacts/backend/app.jar

          cp backend/novels/Dockerfile artifacts/backend/Dockerfile
          cp backend/novels/docker-compose.yml artifacts/backend/docker-compose.yml

      # ---------- SSH + Rsync ----------
      - name: Install ssh + rsync
        run: sudo apt-get update && sudo apt-get install -y openssh-client rsync

      - name: Start ssh-agent and add key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_RSA }}

      - name: Test SSH (accept-new)
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          ssh -vvv -p ${{ secrets.SERVER_PORT }} \
            -o BatchMode=yes \
            -o StrictHostKeyChecking=accept-new \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "echo SSH_OK"

      - name: Deploy frontend dist
        env:
          DEPLOY_FRONTEND_DIR: ${{ secrets.DEPLOY_FRONTEND_DIR }}
        run: |
          set -euo pipefail

          DEPLOY_FRONTEND_DIR="$(printf '%s' "$DEPLOY_FRONTEND_DIR" | tr -d '\r\n')"
          DEPLOY_FRONTEND_DIR="${DEPLOY_FRONTEND_DIR%/}"

          if [ -z "$DEPLOY_FRONTEND_DIR" ] || [ "$DEPLOY_FRONTEND_DIR" = "/" ]; then
            echo "ERROR: DEPLOY_FRONTEND_DIR is empty or '/'. Refusing to rsync."
            exit 1
          fi

          rsync -avz --delete \
            -e "ssh -p ${{ secrets.SERVER_PORT }} -o BatchMode=yes -o StrictHostKeyChecking=yes" \
            artifacts/frontend/ \
            "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${DEPLOY_FRONTEND_DIR}/"

      - name: Deploy backend (Docker context)
        run: |
          rsync -avz -e "ssh -p ${{ secrets.SERVER_PORT }}" \
            artifacts/backend/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_BACKEND_DIR }}/

      - name: Rebuild & restart backend container
        run: |
          ssh -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          cd /root/apps/novels/backend
          docker compose up -d --build
          docker ps --filter "name=novels-api"
          sudo systemctl reload nginx
          EOF
