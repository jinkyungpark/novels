# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
# This workflow will build a Java project with Gradle and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle

name: Deploy Frontend + Backend (Docker)

on:
  push:
    branches: ["main"]
    paths:
      - "novels/frontend/**"
      - "novels/backend/**"
      - ".github/workflows/deploy.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- Frontend (Vite) ----------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: Install frontend deps
        working-directory: frontend/novels
        run: npm ci

      - name: Build frontend
        working-directory: frontend/novels
        run: npm run build

      # ---------- Backend (Spring Boot) ----------
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: "gradle"

      # gradlew 실행 권한 부여
      - name: Make gradlew executable
        working-directory: backend/novels
        run: chmod +x gradlew

      - name: Build backend (skip tests)
        working-directory: backend/novels
        run: ./gradlew clean build -x test

      # ---------- Prepare artifacts ----------
      - name: Prepare artifacts
        run: |
          mkdir -p artifacts/frontend artifacts/backend

          # frontend dist
          cp -r frontend/novels/dist/* artifacts/frontend/

          # backend jar -> app.jar (plain.jar 제외)
          JAR_PATH=$(ls backend/novels/build/libs/*.jar | grep -v -- '-plain\.jar' | head -n 1)
          if [ -z "$JAR_PATH" ]; then
            echo "No runnable jar found in novels/backend/build/libs"
            ls -al backend/novels/build/libs || true
            exit 1
          fi
          cp "$JAR_PATH" artifacts/backend/app.jar

          cp backend/novels/Dockerfile artifacts/backend/Dockerfile
          cp backend/novels/docker-compose.yml artifacts/backend/docker-compose.yml

      # ---------- SSH + Rsync ----------

      - name: Setup SSH
        env:
          HOST: ${{ secrets.SERVER_HOST }}
          PORT: ${{ secrets.SERVER_PORT }}
        run: |
          sudo apt-get update && sudo apt-get install -y openssh-client
          mkdir -p ~/.ssh

          # 개인키 저장
          printf '%s' "$SERVER_SSH_RSA_B64" | base64 -d > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # ✅ 여기서 실패하면 "키 저장/형식" 문제
          ssh-keygen -y -f ~/.ssh/id_rsa > /dev/null

          # 호스트키 등록 (실패해도 원인 보기 위해 먼저 echo)
          echo "Scanning host key..."
          ssh-keyscan -p "$PORT" -H "$HOST" >> ~/.ssh/known_hosts 2>/tmp/keyscan.err || true

          echo "---- keyscan stderr ----"
          cat /tmp/keyscan.err || true

          # 실제 호스트키 라인이 들어왔는지 검사
          if ! tail -n 50 ~/.ssh/known_hosts | grep -qE 'ssh-(rsa|ed25519)|ecdsa-'; then
            echo "ERROR: host keys not added to known_hosts"
            exit 1
          fi

      - name: Test SSH login
        run: |
          ssh -p ${{ secrets.SERVER_PORT }} \
            -o BatchMode=yes -o StrictHostKeyChecking=yes \
            -i ~/.ssh/id_rsa \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo SSH_OK && whoami && hostname"

      - name: Install rsync & ssh
        run: sudo apt-get update && sudo apt-get install -y rsync openssh-client

      - name: Deploy frontend dist
        run: |
          DEPLOY_FRONTEND_DIR="$(printf '%s' "$DEPLOY_FRONTEND_DIR" | tr -d '\r\n')"
          DEPLOY_FRONTEND_DIR="${DEPLOY_FRONTEND_DIR%/}"

          if [ -z "$DEPLOY_FRONTEND_DIR" ] || [ "$DEPLOY_FRONTEND_DIR" = "/" ]; then
            echo "ERROR: DEPLOY_FRONTEND_DIR is empty or '/'. Refusing to rsync."
            exit 1
          fi

          rsync -avz --delete -e "ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }}" \
            artifacts/frontend/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_FRONTEND_DIR }}

      - name: Deploy backend (Docker context)
        run: |
          rsync -avz -e "ssh -p ${{ secrets.SERVER_PORT }}" \
            artifacts/backend/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_BACKEND_DIR }}/

      - name: Rebuild & restart backend container
        run: |
          ssh -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          cd /root/apps/novels/backend
          docker compose up -d --build
          docker ps --filter "name=novels-api"
          sudo systemctl reload nginx
          EOF
